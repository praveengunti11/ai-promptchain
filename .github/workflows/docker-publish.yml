name: Build and Push Docker image

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      #- name: Log in to Docker Hub
      #  uses: docker/login-action@v2
      #  with:
      #    username: ${{ secrets.DOCKERHUB_USERNAME }}
      #    password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image and export image layout to local directory
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: false
          platforms: linux/amd64,linux/arm64
          output: type=local,dest=./output

      - name: Create tar from exported output
        run: |
          if [ -d "./output" ]; then
            tar -C ./output -cf ./ai-promptchain-image.tar .
            ls -lh ./ai-promptchain-image.tar
          else
            echo "Export folder ./output not found"
            find . -maxdepth 4 -type f -name "*.tar" -ls || true
            exit 1
          fi

      - name: List workspace and confirm tar
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -la
          if [ -f "./ai-promptchain-image.tar" ]; then
            echo "Tar found"
            ls -lh ./ai-promptchain-image.tar
          else
            echo "Tar not found in workspace"
            find . -maxdepth 4 -type f -name "*.tar" -ls || true
            exit 1
          fi

      - name: Upload image tar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-tar
          path: ai-promptchain-image.tar
